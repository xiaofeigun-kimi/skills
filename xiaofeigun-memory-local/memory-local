#!/bin/bash
# å°é£æ£è®°å¿†æœç´¢ CLI åŒ…è£…å™¨
# è®© OpenClaw å¯ä»¥é€šè¿‡ exec è°ƒç”¨
# ä½œè€…ï¼šå°é£æ£ ğŸª„

WORKSPACE="${OPENCLAW_WORKSPACE:-$HOME/.openclaw/workspace}"
SERVER_URL="${MEMORY_SERVER_URL:-http://127.0.0.1:8787}"

# æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
check_server() {
    if ! curl -s "$SERVER_URL/health" > /dev/null 2>&1; then
        echo "âŒ è®°å¿†æœç´¢æœåŠ¡æœªå¯åŠ¨"
        echo "è¯·å…ˆè¿è¡Œ: python3 $(dirname $0)/memory_server.py"
        exit 1
    fi
}

# æœç´¢è®°å¿†
search() {
    check_server
    local query="$1"
    local top_k="${2:-5}"
    
    # URL ç¼–ç 
    query=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$query'))")
    
    curl -s "$SERVER_URL/search?q=$query&top_k=$top_k" | python3 -m json.tool
}

# æ›´æ–°ç´¢å¼•
update() {
    check_server
    curl -s -X POST "$SERVER_URL/update" \
        -H "Content-Type: application/json" \
        -d '{"incremental": true}' | python3 -m json.tool
}

# æ˜¾ç¤ºç»Ÿè®¡
stats() {
    check_server
    curl -s "$SERVER_URL/stats" | python3 -m json.tool
}

# ä¸»å…¥å£
case "$1" in
    search)
        search "$2" "$3"
        ;;
    update)
        update
        ;;
    stats)
        stats
        ;;
    *)
        echo "ğŸª„ xiaofeigun-memory-local"
        echo ""
        echo "ç”¨æ³•: memory-local <command> [args]"
        echo ""
        echo "å‘½ä»¤:"
        echo "  search <query> [top_k]  - æœç´¢è®°å¿†"
        echo "  update                  - æ›´æ–°ç´¢å¼•"
        echo "  stats                   - æ˜¾ç¤ºç»Ÿè®¡"
        echo ""
        echo "ç¯å¢ƒå˜é‡:"
        echo "  OPENCLAW_WORKSPACE      - å·¥ä½œç›®å½• (é»˜è®¤: ~/.openclaw/workspace)"
        echo "  MEMORY_SERVER_URL       - æœåŠ¡åœ°å€ (é»˜è®¤: http://127.0.0.1:8787)"
        echo ""
        echo "ç¤ºä¾‹:"
        echo "  memory-local search 'å°èå­' 3"
        exit 1
        ;;
esac